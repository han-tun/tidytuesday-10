---
title: "Canadian Wind Turbines"
author: "Kaustav Sen"
date: "10/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-libraries}
library(tidyverse)
library(ggtext)
library(showtext)
```

```{r load-fonts}
font_add_google("Roboto Condensed", "h_font") # Font for table heading
font_add_google("Roboto", "b_font") # Font for subtitle and plot body
font_add_google("Roboto Mono", "d_font") # Font for numbers (and digits) in the plot
```


```{r get-data}
tuesdata <- tidytuesdayR::tt_load(2020, week = 44)

wind_turbine <- tuesdata$`wind-turbine`
```

```{r wrangle}
distinct_projects <- 
  wind_turbine %>% 
  mutate(
    commissioning_date = str_extract(commissioning_date, "[:digit:]+") %>% as.double()
  ) %>% 
  distinct(project_name, province_territory, total_project_capacity_mw, commissioning_date) 
```

```{r plot}
showtext_auto()

plot_data <- 
  distinct_projects %>% 
  group_by(project_name) %>% 
  # If a project has multiple commissioning dates, select the earliest one
  filter(commissioning_date == min(commissioning_date)) %>% 
  ungroup() %>% 
  count(year = commissioning_date)

plot <- 
  ggplot(plot_data, aes(year, n)) +
  geom_point(size = 2)  +
  geom_point(data = filter(plot_data, year %in% c(2014, 2015)), size = 2.5, color = "#E69F00")  +
  geom_hline(yintercept = 10, size = 1.05, color = "grey80") +
  geom_segment(aes(x = year, xend = year, y = n, yend = 10)) +
  geom_segment(data = filter(plot_data, year %in% c(2014, 2015)), aes(x = year, xend = year, y = n, yend = 10), color = "#E69F00") +
  scale_y_continuous(sec.axis = dup_axis()) +
  scale_x_continuous(breaks = c(1995, 2005, 2015)) +
  labs(
    title = "Number of new projects commissioned each year",
    subtitle = "With 269 distinct projects over a 26 year period from 1993 to 2019, we would expect<br />on **average 10 projects per year**",
    caption = "**Data**: open.canada.ca | **Plot**: Kaustav Sen"
  ) +
  annotate("text", x = 2003, y = 38, hjust = 0, size = 3.5, family = "b_font", color = "grey40", label = "There was a sudden spike in the number of\nprojects commissioned in years 2014 and 2015") +
  ggthemes::theme_fivethirtyeight() +
  theme(
    plot.title = element_text(family = "h_font"),
    plot.subtitle = element_markdown(family = "b_font", color = "grey30", margin = margin(b = 20)),
    plot.caption = element_markdown(family = "b_font", size = 8.5, margin = margin(t = 15)),
    plot.title.position = "plot",
    panel.grid.minor.x = element_blank(),
    axis.text = element_text(family = "d_font")
  )
```

```{r save-plot}
file_path <- here::here(2020, "plots", "week_44")
ggsave(paste0(file_path, ".pdf"), plot, height = 7, width = 8, device = cairo_pdf)
pdftools::pdf_convert(paste0(file_path, ".pdf"), filenames = paste0(file_path, ".png"), dpi = 300)
```